<script>
    $(function() {

        $("#label_multi").chosen({});
        getDraftLabels();
    });

    $('#field_to').keyup(function(event) {

        // skip for arrow keys
        if (event.which >= 37 && event.which <= 40) return;

        // format number
        $(this).val(function(index, value) {
            if (value.endsWith(".com")) {
                return value + ', ';
            }
            return value;

        });
    });

   // $('#sampleTextArea').keydown(function() {
        //    if (this.value.length > 124) {
        //        return false;
        //    }
    //    $("#remainingChar").html("Characters : " + (this.value.length + 1));
   // });

   // $('#subject_textarea').keydown(function() {
        //    if (this.value.length > 124) {
        //        return false;
        //    }
    //    console.log(this.value.length);
     //   $("#remainingCharSub").html("Characters : " + (this.value.length + 1));
    //});
    
    $('#sampleTextArea').keyup(function() {
        //    if (this.value.length > 124) {
        //        return false;
        //    }
        $("#remainingChar").html("Characters : " + (this.value.length));
    });
    
    
    $('#subject_textarea').keyup(function() {
        //    if (this.value.length > 124) {
        //        return false;
        //    }
        console.log(this.value.length);
        $("#remainingCharSub").html("Characters : " + (this.value.length));
    });


    var CLOSE_SIDEBAR = false;
    $('#save_draft').on('click', function() {
        CLOSE_SIDEBAR = true;
        SaveFiles();

    });

    $('#save_new_draft').on('click', function() {
        CLOSE_SIDEBAR = false;
        SaveFiles();
    });


    var reader = new FileReader();
    var files;
    var fileCounter = 0;
    reader.onloadend = function() {
        var folderName = '[Jukebox Upload]';
        google.script.run
            .withSuccessHandler(function(file_id) {
                saveFormValues(file_id);
                localStorage.setItem("attachId", file_id);
                var note = localStorage.getItem("attachId");
                
                showToast('Upload complete!');
                fileCounter++;
                postNextFile();
                $('.loading_spinner').hide('slow');
//                google.script.host.close();
            }).saveFile(reader.result, files[fileCounter].name, folderName);
    }

    function SaveFiles() {
        if ($('#myFiles').val() == "") {
            //showToast('Please upload file!');
            saveFormValues(null);
            return 0;
        }
        $('.loading_spinner').show();
        var folderSelect = document.getElementById("folderSelectId");
        files = document.getElementById("myFiles").files;
         console.log(files[0]);
        
        if( (files[0]['size'] / (1024*1024))  >5 ){
         showToast('Please upload file less then 5MB!');
          $('.loading_spinner').hide('slow');
         return false;
        }
        
       
        //return false;
        postNextFile();
    }

    function postNextFile() {
        if (fileCounter < files.length) {
            reader.readAsDataURL(files[fileCounter]);
        } else {
            fileCounter = 0;
            $('#myFiles').val('');
        }
    }

    function getDraftLabels() {
        google.script.run
            .withSuccessHandler(function(names) {
                console.log(names);
                $('#label_multi').html('');
                for (var i = 0; i < names.length; i++) {
                    $('#label_multi').append("<option value='" + names[i] + "'>" + names[i] + "</option>");
                }
                $('#label_multi').trigger("chosen:updated");
            })
            .withFailureHandler(showError)
            .getAllGmailLabels();
    }

    /**
     * Inserts a div that contains an error message after a given element.
     *
     * @param msg The error message to display.
     * @param element The element after which to display the error.
     */
    function showError(msg, element) {
        console.log(msg);
        var div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
    }

    function showToast(msg) {
        // Get the snackbar DIV
        var x = $('#snackbar'); //document.getElementById("snackbar")
        // Add the "show" class to DIV
        $('#snackbar').html(msg);
        $('#snackbar').addClass('show');
        // After 3 seconds, remove the show class from DIV
        setTimeout(function() {
            $('#snackbar').removeClass('show');
            $('#snackbar').html('');
        }, 3000);
    }

    function saveFormValues(attach_id) {

        $('.loading_spinner').show();
        var subject = $('#subject_textarea').val();
        subject = subject.replace(/<(?!br\s*\/?)[^>]+>/g, '');
        
        var body = $('#sampleTextArea').val();
        body = body.replace(/<(?!br\s*\/?)[^>]+>/g, '');
        
        var to = $('#field_to').val();
        var labels = $('#label_multi').chosen().val() || "";
        var weight = $('#select_repeat').val();
        var attachment = attach_id; //localStorage.getItem("attachId");
        
        
        if(subject == '' || body == ''|| to == ''){
        showToast('Error creating Draft, correct your data.');
        $('.loading_spinner').hide('slow');
        return false;
        }
        
       var to_array = to.split(',');


       for(var i =0; i < to_array.length; i++){
       if(to_array[i].trim() != ''){
       console.log(to_array[i].trim());
       
        var email_json = {
            subject: subject.split('\n').join(' '),
            body: body.split('\n').join('<br />'),
            to: to_array[i].trim(),
            labels: labels,
            weight: weight,
            attachment: attachment
        }
        console.log(email_json);
        google.script.run.withFailureHandler(showError)
            .withSuccessHandler(function(resp) {
                if (resp) {
                    showToast('Draft Created!');
                    localStorage.removeItem("attachId");
                    console.log(resp.id);
                    // Add email Post created by owner to Playlist sheet
                    google.script.run.withFailureHandler(showError)
                        .withSuccessHandler(function(resp) {
                        console.log("Written in sheet");
                        }).addSentEmailInfoToSheet({
                            id: resp.id,
                            subject: resp.subject,
                            body: resp.body,
                            to: resp.to,
                            attachment: resp.attachment,
                            sent: "Not Sent",
                            label: resp.label
                        });
                        
                } else {
                    showToast('Error creating Draft, correct your data.');
                }

                $('.loading_spinner').hide('slow');
                setTimeout(function() {

                    if (CLOSE_SIDEBAR) {
                        google.script.host.close();
                    } else {
                        resetFormFields();
                    }
                }, 3000);

            }).createDraftWithAttachments(email_json);
            
            }}
    }

    function resetFormFields() {

        $('#subject_textarea').val('');
        $('#sampleTextArea').val('');
        $('#remainingCharSub').html('Characters : 0');
        $('#remainingChar').html('Characters : 0');
        $('#field_to').val('');
        $('#myFiles').val('');
        $('#label_multi').val('').trigger("chosen:updated");
    }
</script>