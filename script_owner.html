<script>
/**
 * On document load, assign click handlers to each button and try to load the
 * user's origin and destination language preferences if previously set.
 */
$(function() {
//    loadLabelPref();
    $("#datepicker").datepicker();
    $("#datepicker").datepicker('setDate', new Date());

    $("#datepicker_main").datepicker();
    $("#datepicker_main").datepicker('setDate', new Date());
    $("#datepicker1").datepicker({
        dateFormat: "dd MM",
        changeMonth: true,
        changeDay: true
    });
    $("#datepicker1").datepicker('setDate', new Date());
    $("#datepicker2").datepicker({
        dateFormat: "MM",
        changeMonth: true,
        onClose: function(dateText, inst) {
            $(this).datepicker('setDate', new Date(inst.selectedYear, inst.selectedMonth, 1));
        }
    });
    getDraftLabels();
    $("#" + $('#select').val().toLowerCase()).show().siblings().hide();
    $('#input_timepicker').timepicker({
        startTime: '00:00',
        interval: 60
    });
    $('#input_timepicker1').timepicker({
        startTime: '00:00',
        interval: 60
    });
 
});

/**
 * Callback function that populates the origin and destination selection
 * boxes with user preferences from the server.
 *
 * @param {Object} languagePrefs The saved origin and destination languages.
 */
function loadPreferences(languagePrefs) {
    console.log('testing');
    $('input:radio[name="origin"]')
        .filter('[value=' + languagePrefs.originLang + ']')
        .attr('checked', true);
    $('input:radio[name="dest"]')
        .filter('[value=' + languagePrefs.destLang + ']')
        .attr('checked', true);
}

 /**
 * Inserts a div that contains an error message after a given element.
 *
 * @param msg The error message to display.
 * @param element The element after which to display the error.
 */
function showError(msg, element) {
    console.log(msg);
    var div = $('<div id="error" class="error">' + msg + '</div>');
    $(element).after(div);
    $('.loading_spinner').hide('slow');
}

$('#field_to').keyup(function(event) {

    // skip for arrow keys
    if (event.which >= 37 && event.which <= 40) return;

    // format number
    $(this).val(function(index, value) {
        if (value.endsWith(".com")) {
            return value + ', ';
        }
        return value;

    });
});

$('#select').change(function() {
    $("#" + $(this).val().toLowerCase()).show().siblings().hide();
    console.log($(this).val());
});
var CLOSE_SIDEBAR = false;
$('#save_btn').on('click', function(e) {
    e.preventDefault();
    CLOSE_SIDEBAR = true;
    saveDataToServer();

    return false;
});

$('#save_new_btn').on('click', function(e) {
    e.preventDefault();
    CLOSE_SIDEBAR = false;
    saveDataToServer();

    return false;
});
$('#cancel_btn').on('click', function() {

    resetFormFields();
    return false;
});

function getDraftLabels() {
    google.script.run
        .withSuccessHandler(function(names) {
            $('#draft_labels').html('');
            var arr = [];
            for (var i = 0; i < names.length; i++) {
                //$('#draft_labels').append("<option value='" + names[i] + "'>");
                arr.push(names[i])
            }
            $('#field_label').autocomplete({
                minLength: 0,
                source: arr,
                select: function(event, ui) {
                    var label = ui.item.label;
                    var value = ui.item.value;
                    //store in session
                    //console.log(value, label);
                    setAutoCompleteValue(value)

                }
            }).focus(function() {
                $(this).autocomplete("search", "");
            });
        })
        .withFailureHandler(showError)
        .getAllGmailLabelsFromOwner();
}

function isObjectValueEmpty(obj) {

    var k;
    if (obj instanceof Object) {
        for (k in obj) {
            if (obj.hasOwnProperty(k) && obj[k]) {
                //recursive call to scan property
                isObjectValueEmpty(obj[k]);
            } else {
                return true;
            }
            console.log(typeof obj[k]);
        }
    } else {
        //not an Object so obj[k] here is a value
        if (obj == "") {
            return true;
        }

    }
    return false;
}

function loadLabelPref() {
    $('#field_label').on('change', function() {

        if ($(this).val()) {
            var label = $(this).val();
            google.script.run
                .withSuccessHandler(function(json) {
                console.log("Pref loaded ",json);
                    if (json) {
                        resetFormFields();
                        setLabelPref(JSON.parse(json));
                        console.log(JSON.parse(json));
                        var obj = JSON.parse(json);
                        google.script.run
                            .withFailureHandler(showError)
                            .withSuccessHandler(function(json) {
                                console.log('Set Active Sheet!');
                            }).setActiveSheetByLabel(obj.f_label);
                    }
                }).withFailureHandler(showError)
                .getUserLabelPref(label);

        }
    });
}

function setAutoCompleteValue(valueInput) {

    if (valueInput) {
        var label = valueInput;
        google.script.run
            .withSuccessHandler(function(json) {
             console.log("Pref loaded ",json);
                if (json) {
                    resetFormFields();
                    setLabelPref(JSON.parse(json));
                    console.log(JSON.parse(json));
                    var obj = JSON.parse(json);
                    google.script.run
                        .withFailureHandler(showError)
                        .withSuccessHandler(function(json) {
                            console.log('Set Active Sheet!');
                        }).setActiveSheetByLabel(obj.f_label);
                }
            }).withFailureHandler(showError)
            .getUserLabelPref(label);

    }
}

function setLabelPref(json) {

    $('#field_label').val(json.f_label);
    $('#field_to').val(json.f_to);
    $('#datepicker').val(json.f_datepicker);
    $('#select').val(json.f_repeat);
    $('#select option[value="' + json.f_repeat + '').prop("selected", true).trigger('change');

    if (json.f_repeat == 'Weekly') {
        $('#select_repeat').val(json.f_repeat_num);
        for (var i = 0; i < json.f_repeat_days.length; i++) {
            var day = json.f_repeat_days[i];
            $('#week_repeat_week1 label').each(function(index, item) {
                if ($(item).children().get(1).innerHTML == day) {
                    $(item).children().get(0).click();
                }
            });
        }
    } else if (json.f_repeat == 'Monthly') {
     
        $('#monthly #select_repeat').val(json.f_repeat_monthly);
        var check_radio = Object.keys(json.f_radio_month)[0];
        if (check_radio == 'day') {
            $('#monthly #radio_month1').click();
            $('#monthly #select_day_of_month').val(json.f_radio_month.day);
        } else {
            $('#monthly #radio_month2').click();
            $('#monthly #select_repeat_days').val(json.f_radio_month.weeks.day);
            $('#monthly #select_repeat_week').val(json.f_radio_month.weeks.week);
        }

    } else if (json.f_repeat == 'Yearly') {
       $('#yearly #select_repeat').val(json.f_repeat_yearly);
       var check_radio = json.f_radio_yearly.every.length;
       if(check_radio == 1){
         $('#yearly .radio_every').click();
         $('#datepicker1').val(json.f_radio_yearly.every[0])
       }
       else if(check_radio > 1){
         $('#yearly #radio_after').click();
         $('#yearly #select_repeat_days').val(json.f_radio_yearly.every[0]);
         $('#yearly #select_repeat_week').val(json.f_radio_yearly.every[1]);
         $('#yearly #datepicker2').val(json.f_radio_yearly.every[2]);
       }
    }

    var radio = json.f_radio;
    var radio_check = Object.keys(radio)[0];
    //    if (radio_check == 'after') {
    //        $('.radio_weekly #radio_after').click();
    //        $('.radio_weekly #input_days').val(radio[radio_check])
    //    } else 
    if (radio_check == 'on') {
        $('.radio_weekly #radio_on').click();
        $('.radio_weekly #datepicker_main').val(radio[radio_check]);
    } else {
        $('.radio_weekly #radio_never').click();
    }
    $('#input_timepicker').val(json.f_timepicker_from);
    $('#input_timepicker1').val(json.f_timepicker_to);
    $('#input_numberpicker').val(json.f_numberpicker_per);
    $('#input_numberpicker1').val(json.f_numberpicker_not);
    showToast('Preferences Loaded!');
}

function resetFormFields() {
    $('input').each(function(ind, item) {
        $(item).val('');
    });
    $('#week_repeat_week1 [type=checkbox]').attr('checked', false);
    $('#weekly .radio_weekly #radio_never').click();

}

function saveToSpreadsheet(json) {
    google.script.run
        .withSuccessHandler(function(resp) {
            if (resp) {
                console.log(resp);
            }
        }).withFailureHandler(showError)
        .setLabelPrefToSheet(json);
}

$('#trash_btn').on('click', function(e) {
    e.preventDefault();
    $('.loading_spinner').show();
    var lbl = $('#field_label').val() || '';
    google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(function(response) {
            if (response == 1) {
                google.script.run
                    .withSuccessHandler(function(data) {
                        if (data) {
                            showToast('Preferences deleted!');
                            console.log('Preferences deleted!');
                            resetFormFields();
                            $('.loading_spinner').hide('slow');
                        }
                    })
                    .withFailureHandler(showError)
                    .deleteUserLabelPref(lbl);
            }
            $('.loading_spinner').hide('slow');
        }).showPrompt('Are you sure you want to delete this playlist?')

    return false;
});

function showToast(msg) {
    // Get the snackbar DIV
    var x = $('#snackbar'); //document.getElementById("snackbar")
    // Add the "show" class to DIV
    $('#snackbar').html(msg);
    $('#snackbar').addClass('show');
    // After 3 seconds, remove the show class from DIV
    setTimeout(function() {
        $('#snackbar').removeClass('show');
        $('#snackbar').html('');
    }, 3000);
}

function saveDataToServer() {
    var json_obj = {
        f_label: $('#field_label').val(),
        f_to: $('#field_to').val(),
        f_datepicker: $('#datepicker').val(),
        f_repeat: $('#select').val(),
    }
    json_obj.f_repeat_num = $('#select_repeat').val();
    var arr_validate = [$('#field_label'), $('#field_to'), $('#datepicker')];
    if (json_obj.f_repeat == 'Weekly') {

        json_obj.f_repeat_days = $('#week_repeat_week1 label').map(function(index, item) {
            if ($(item).children().get(0).checked) {
                return $(item).children().get(1).innerHTML;
            }
        });
        json_obj.f_repeat_days = json_obj.f_repeat_days.toArray();

    } else if (json_obj.f_repeat == 'Monthly') {
        json_obj.f_repeat_monthly = $('#monthly #select_repeat').val();
        var radio_month = $('.checkbox_days_monthly input[type=radio]:checked').next('label').html();
        if (radio_month == 'Day') {
            json_obj.f_repeat_days = $('#monthly #select_day_of_month').val();
            json_obj.f_radio_month = {
                'day': $('#monthly #select_day_of_month').val()
            };

        } else {
            json_obj.f_repeat_days = $('#monthly #select_repeat_days').val() + "-" + $('#monthly #select_repeat_week').val();
            json_obj.f_radio_month = {
                'weeks': {
                    'day': $('#monthly #select_repeat_days').val(),
                    'week': $('#monthly #select_repeat_week').val()
                }
            }
        }

    } else if (json_obj.f_repeat == 'Yearly') {
        json_obj.f_repeat_yearly = $('#yearly #select_repeat').val();
        var check_yearly = $('#yearly .checkbox_days input[type=radio]:checked').next().html();
        if (check_yearly == 'Every') {
            json_obj.f_repeat_days = $('#yearly #datepicker1').val();
            json_obj.f_radio_yearly = {
                'every': [$('#yearly #datepicker1').val()]
            }
        } else if (check_yearly) {
            json_obj.f_repeat_days = $('#yearly #select_repeat_days').val() + "-" + $('#yearly #select_repeat_week').val() +
                '-' + $('#yearly #datepicker2').val();
            json_obj.f_radio_yearly = {
                'every': [
                    $('#yearly #select_repeat_days').val(),
                    $('#yearly #select_repeat_week').val(),
                    $('#yearly #datepicker2').val()
                ]
            }
        }
    }

    var radio = $('.radio_weekly input[type=radio]:checked').next('label').html();

    if (radio == 'On') {
        json_obj.f_radio = {
            'on': $('.radio_weekly #datepicker_main').val() || null
        };
        arr_validate.push($('.radio_weekly #datepicker_main'));
    } else {
        json_obj.f_radio = {
            'never': ' '
        };

    }
    json_obj.f_timepicker_from = $('#input_timepicker').val();
    json_obj.f_timepicker_to = $('#input_timepicker1').val();
    json_obj.f_numberpicker_per = $('#input_numberpicker').val();
    json_obj.f_numberpicker_not = $('#input_numberpicker1').val();
    arr_validate.push($('#input_timepicker'), $('#input_timepicker1'), $('#input_numberpicker'), $('#input_numberpicker1'));
    console.log(json_obj);
    console.log(arr_validate);

    for (var i = 0; i < arr_validate.length; i++) {
        if ($(arr_validate[i]).val() == '') {
            $(arr_validate[i]).prop('required', true);
            $(arr_validate[i]).effect("shake");
            return false;
        } else {
            $(arr_validate[i]).prop('required', false);
        }
    }
    
    
    /* custom code */
    
    google.script.run
    .withFailureHandler(showError)
    .withSuccessHandler(function(json) {
    console.log('delete default Sheet!');
    }).deleteDefaultSheetByLabel();
    /* custom code */
    
    
    $('.loading_spinner').show();
     google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(function(compareBool) {
        console.log("Compare Hours ",compareBool)
        if(compareBool.toString() == 'false' ){
        
    json_obj.toggle = 1;
 
       google.script.run
        .withFailureHandler(showError)
        .withSuccessHandler(function(data) {
            showToast('Option saved!');
            console.log("Option saved! ".data);
            saveToSpreadsheet(json_obj);
            $('.loading_spinner').hide('slow');
            if (CLOSE_SIDEBAR) {
                google.script.host.close();
            } else {
                resetFormFields();
            }
        }).savePlaylistEmailToDocProps( json_obj );
        
               
        }
        else{
            showToast('Chosen Hour From: cannot be greater than Hour To: ');
            $('.loading_spinner').hide('slow');
            return;
            
        }
        }).compareHours(json_obj.f_timepicker_from, json_obj.f_timepicker_to);

}
</script>
